<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SWIPENOW - Upload Meme</title>
       <link
  rel="preload"
  href="/assests/SmoochSans-VariableFont_wght.ttf"
  as="font"
  type="font/ttf"
  crossorigin
/>
  <link rel="stylesheet" href="/styling/pages/uplodememe.css">
  <link rel="icon" href="/assests/icon/favicon-96x96.png">

  <style>
    #popup {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 9999;
      display: none;
    }
  </style>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "42d4b147-37f6-4d4b-90af-7b0727be1048",
    });

    // Ask the user to allow notifications
    const isPushEnabled = await OneSignal.isPushNotificationsEnabled();
    if (!isPushEnabled) {
      OneSignal.showSlidedownPrompt(); // Opens the permission dialog
    }
  });
</script>
</head>

<body>

<div class="container">
  <p class="actualedit">Upload MEME</p>

  <form class="file-upload-form">
    <label class="file-upload-label">
      <input id="file" type="file" accept="image/*" hidden />
      <div class="file-upload-design">
        <p>Drag & Drop or Browse</p>
      </div>
    </label>
  </form>

  <div class="imgcontainer">
    <img id="imagePreview" style="display:none;max-width:300px;" />
  </div>

  <div class="flex">
    <input type="text" class="username-input" id="titleInput" placeholder="Enter Caption" />
  </div>

  <div class="buttons">
    <button type="button" onclick="history.back()">Back</button>
    <button id="uploadBtn" disabled>Upload</button>
  </div>
</div>

<div id="popup"></div>

<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

<!-- NSFWJS -->
<script src="https://cdn.jsdelivr.net/npm/nsfwjs@4.2.1/dist/browser/nsfwjs.min.js"></script>

<script>
let nsfwModel = null;
let compressedFile = null;

const fileInput = document.getElementById("file");
const imagePreview = document.getElementById("imagePreview");
const uploadBtn = document.getElementById("uploadBtn");
const popup = document.getElementById("popup");

/* ================= POPUP ================= */
function showPopup(text, color) {
  popup.innerHTML = `${text} <span style="margin-left:10px;cursor:pointer">‚úñ</span>`;
  popup.style.background = color;
  popup.style.display = "block";
  popup.onclick = () => popup.style.display = "none";
  setTimeout(() => popup.style.display = "none", 4000);
}

/* ================= IMAGE COMPRESSION ================= */
async function compressImage(file, minKB = 50, maxKB = 75) {
  return new Promise((resolve) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const maxWidth = 1024;
      let { width, height } = img;

      if (width > maxWidth) {
        height = height * (maxWidth / width);
        width = maxWidth;
      }

      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);

      let quality = 0.9;

      function tryCompress() {
        canvas.toBlob(blob => {
          const sizeKB = blob.size / 1024;

          if (sizeKB > maxKB && quality > 0.3) {
            quality -= 0.05;
            tryCompress();
          } else {
            resolve(new File([blob], file.name, {
              type: "image/jpeg",
              lastModified: Date.now()
            }));
          }
        }, "image/jpeg", quality);
      }

      tryCompress();
    };

    reader.readAsDataURL(file);
  });
}

/* ================= LOAD NSFW MODEL ================= */
window.addEventListener("load", async () => {
  try {
    nsfwModel = await nsfwjs.load("/assests/models/");
    showPopup("‚úÖ NSFW Scanner Ready", "#2ecc71");
  } catch {
    showPopup("‚ùå NSFW Model Load Failed", "#e74c3c");
  }
});

/* ================= FILE CHANGE ================= */
fileInput.addEventListener("change", async (e) => {
  let file = e.target.files[0];
  if (!file) return;

  if (!nsfwModel) {
    showPopup("‚è≥ Model still loading...", "#f39c12");
    return;
  }

  // üì¶ ORIGINAL SIZE (MB)
  const originalMB = file.size / (1024 * 1024);

  showPopup("‚è≥ Compressing image...", "#3498db");

  // üî• COMPRESS
  compressedFile = await compressImage(file);

  const compressedKB = compressedFile.size / 1024;
  const reducedPercent = ((file.size - compressedFile.size) / file.size) * 100;

  console.log(
    `üì¶ Original: ${originalMB.toFixed(2)} MB`
  );
  console.log(
    `üìâ Compressed: ${compressedKB.toFixed(1)} KB`
  );
  console.log(
    `üî• Reduced: ${reducedPercent.toFixed(1)}%`
  );

  showPopup(`üìâ Compressed to: ${compressedKB.toFixed(1)} KB`, "#2ecc71");

  // Preview compressed image
  imagePreview.src = URL.createObjectURL(compressedFile);
  imagePreview.style.display = "block";

  imagePreview.onload = async () => {
    const predictions = await nsfwModel.classify(imagePreview);

    console.log("üß† NSFW Model Predictions:");
    predictions.forEach(p => {
      console.log(`${p.className}: ${(p.probability * 100).toFixed(2)}%`);
    });

    const isUnsafe = predictions.some(p =>
      ["Porn", "Hentai", "Sexy"].includes(p.className) &&
      p.probability > 0.7
    );

    uploadBtn.disabled = isUnsafe;
    uploadBtn.style.opacity = isUnsafe ? "0.5" : "1";

    showPopup(
      isUnsafe ? "‚ùå NOT SAFE (NSFW)" : "‚úÖ SAFE TO UPLOAD",
      isUnsafe ? "#e74c3c" : "#2ecc71"
    );
  };
});

// /* ================= UPLOAD ================= */
// uploadBtn.addEventListener("click", () => {
//   if (!compressedFile || uploadBtn.disabled) {
//     showPopup("‚ùå Upload Blocked", "#e74c3c");
//     return;
//   }

//   alert("üöÄ Upload compressed image to backend");
// });


/* ================= UPLOAD TO SPRING BOOT ================= */
uploadBtn.addEventListener("click", async () => {
  const title = document.getElementById("titleInput").value.trim();

  const postedBy = localStorage.getItem("username") || "Anonymous";
console.log(postedBy);

  if (!compressedFile || !title || !postedBy || uploadBtn.disabled) {
    showPopup("‚ùå Upload blocked or missing info", "#e74c3c");
    return;
  }

  showPopup("‚è≥ Uploading meme...", "#3498db");
const today = new Date();
const postedDate = today.toISOString().split('T')[0];
 const formData = new FormData();
formData.append("file", compressedFile);
formData.append("title", title);
formData.append("postedBy", postedBy);

try {
    const response = await fetch("https://backend-yf83.onrender.com/upload", {
        method: "POST",
        body: formData
    });

    if (!response.ok) {
        const errorText = await response.text();
        console.error("Upload failed:", errorText);
        showPopup("‚ùå Upload failed", "#e74c3c");
        return;
    }

    const data = await response.json(); // now safe
    console.log("Meme uploaded:", data);
    showPopup("‚úÖ Upload successful", "#2ecc71");
} catch (err) {
    console.error(err);
    showPopup("‚ùå Upload failed", "#e74c3c");
}

});
</script>

</body>
</html>
